<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ultimate Platformer</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  <style>
    body { margin: 0; }
    canvas { display: block; margin: 0 auto; }
    #skinSelect {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
  </style>
</head>
<body>
<select id="skinSelect">
  <option value="dude">Default</option>
  <option value="enemy">Enemy Skin</option>
</select>
<script>
  const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
      default: 'arcade',
      arcade: {
        gravity: { y: 300 },
        debug: false
      }
    },
    scene: {
      preload,
      create,
      update
    }
  };

  const game = new Phaser.Game(config);

  let player, cursors, stars, bombs, score = 0, scoreText, platforms, music;
  let powerUps, enemies, health = 3, healthText, level = 1, selectedSkin = 'dude', boss;

  function preload() {
    this.load.image('sky', 'https://labs.phaser.io/assets/skies/space3.png');
    this.load.image('ground', 'https://labs.phaser.io/assets/sprites/platform.png');
    this.load.image('star', 'https://labs.phaser.io/assets/sprites/star.png');
    this.load.image('bomb', 'https://labs.phaser.io/assets/sprites/bomb.png');
    this.load.image('powerup', 'https://labs.phaser.io/assets/sprites/powerup.png');
    this.load.spritesheet('dude', 'https://labs.phaser.io/assets/sprites/dude.png', { frameWidth: 32, frameHeight: 48 });
    this.load.audio('bgmusic', 'https://labs.phaser.io/assets/audio/loop.ogg');
    this.load.spritesheet('enemy', 'https://labs.phaser.io/assets/sprites/baddie.png', { frameWidth: 32, frameHeight: 32 });
    this.load.spritesheet('boss', 'https://labs.phaser.io/assets/sprites/mushroom-32x32.png', { frameWidth: 32, frameHeight: 32 });
  }

  function create() {
    selectedSkin = document.getElementById('skinSelect').value;

    this.add.image(400, 300, 'sky');
    music = this.sound.add('bgmusic', { loop: true });
    music.play();

    platforms = this.physics.add.staticGroup();
    createLevel(this);

    player = this.physics.add.sprite(100, 450, selectedSkin);
    player.setBounce(0.2);
    player.setCollideWorldBounds(true);

    this.anims.create({ key: 'left', frames: this.anims.generateFrameNumbers(selectedSkin, { start: 0, end: 3 }), frameRate: 10, repeat: -1 });
    this.anims.create({ key: 'turn', frames: [ { key: selectedSkin, frame: 4 } ], frameRate: 20 });
    this.anims.create({ key: 'right', frames: this.anims.generateFrameNumbers(selectedSkin, { start: 5, end: 8 }), frameRate: 10, repeat: -1 });

    this.physics.add.collider(player, platforms);
    cursors = this.input.keyboard.createCursorKeys();

    stars = this.physics.add.group();
    this.physics.add.collider(stars, platforms);
    this.physics.add.overlap(player, stars, collectStar, null, this);

    scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '24px', fill: '#fff' });
    healthText = this.add.text(16, 48, 'Health: 3', { fontSize: '24px', fill: '#fff' });

    bombs = this.physics.add.group();
    this.physics.add.collider(bombs, platforms);
    this.physics.add.collider(player, bombs, takeDamage, null, this);

    powerUps = this.physics.add.group();
    this.physics.add.collider(powerUps, platforms);
    this.physics.add.overlap(player, powerUps, collectPowerUp, null, this);

    enemies = this.physics.add.group();
    this.physics.add.collider(enemies, platforms);
    this.physics.add.collider(player, enemies, takeDamage, null, this);

    boss = this.physics.add.sprite(700, 100, 'boss').setScale(2);
    boss.setBounce(1);
    boss.setCollideWorldBounds(true);
    boss.setVelocity(Phaser.Math.Between(-150, 150), 20);
    boss.setVisible(false);
    this.physics.add.collider(boss, platforms);
    this.physics.add.collider(player, boss, takeDamage, null, this);

    loadEntities(this);

    // Save/load functionality
    window.addEventListener('beforeunload', () => {
      localStorage.setItem('saveScore', score);
      localStorage.setItem('saveLevel', level);
      localStorage.setItem('saveHealth', health);
    });

    // Load saved game
    if (localStorage.getItem('saveScore')) {
      score = parseInt(localStorage.getItem('saveScore'));
      level = parseInt(localStorage.getItem('saveLevel'));
      health = parseInt(localStorage.getItem('saveHealth'));
      scoreText.setText('Score: ' + score);
      healthText.setText('Health: ' + health);
    }
  }

  function update() {
    if (cursors.left.isDown) {
      player.setVelocityX(-160);
      player.anims.play('left', true);
    } else if (cursors.right.isDown) {
      player.setVelocityX(160);
      player.anims.play('right', true);
    } else {
      player.setVelocityX(0);
      player.anims.play('turn');
    }

    if ((cursors.up.isDown || this.input.activePointer.isDown) && player.body.touching.down) {
      player.setVelocityY(-330);
    }
  }

  function collectStar(player, star) {
    star.disableBody(true, true);
    score += 10;
    scoreText.setText('Score: ' + score);

    if (stars.countActive(true) === 0) {
      level++;
      createLevel(this);
      loadEntities(this);
      if (level === 3) {
        boss.setVisible(true);
      }
    }
  }

  function collectPowerUp(player, powerup) {
    powerup.disableBody(true, true);
    score += 50;
    player.setTint(0x00ff00);
    this.time.delayedCall(2000, () => player.clearTint(), [], this);
    scoreText.setText('Score: ' + score);
  }

  function takeDamage(player, enemy) {
    health--;
    healthText.setText('Health: ' + health);
    player.setTint(0xff0000);
    this.time.delayedCall(1000, () => player.clearTint(), [], this);
    if (health <= 0) {
      this.physics.pause();
      player.anims.play('turn');
      music.stop();
      scoreText.setText('Game Over! Final Score: ' + score);
    }
  }

  function createLevel(scene) {
    platforms.clear(true, true);
    platforms.create(400, 568, 'ground').setScale(2).refreshBody();
    platforms.create(600, 400 - (level * 20), 'ground');
    platforms.create(50, 250 - (level * 10), 'ground');
    platforms.create(750, 220 - (level * 10), 'ground');
  }

  function loadEntities(scene) {
    stars.clear(true, true);
    bombs.clear(true, true);
    powerUps.clear(true, true);
    enemies.clear(true, true);

    for (let i = 0; i < 12; i++) {
      stars.create(Phaser.Math.Between(0, 800), 0, 'star').setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
    }

    powerUps.create(Phaser.Math.Between(100, 700), 0, 'powerup').setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

    const enemy = enemies.create(Phaser.Math.Between(100, 700), 0, 'enemy');
    enemy.setBounce(1);
    enemy.setCollideWorldBounds(true);
    enemy.setVelocity(Phaser.Math.Between(-100, 100), 20);
  }
</script>
</body>
</html>
