<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ultimate Platformer</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      touch-action: none;
    }
    canvas {
      display: block;
      margin: 0 auto;
    }
    #skinSelect {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
  </style>
</head>
<body>
<select id="skinSelect">
  <option value="dude">Default</option>
  <option value="enemy">Enemy Skin</option>
</select>
<script>
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  const config = {
    type: Phaser.AUTO,
    width: isMobile ? window.innerWidth : 800,
    height: isMobile ? window.innerHeight : 600,
    physics: {
      default: 'arcade',
      arcade: {
        gravity: { y: 300 },
        debug: false
      }
    },
    scene: {
      preload,
      create,
      update
    },
    scale: {
      mode: Phaser.Scale.RESIZE,
      autoCenter: Phaser.Scale.CENTER_BOTH
    }
  };

  const game = new Phaser.Game(config);

  let player, cursors, stars, bombs, score = 0, scoreText, platforms, music;
  let powerUps, enemies, health = 3, healthText, level = 1, selectedSkin = 'dude', boss;
  let pointerJump = false;

  function preload() {
    this.load.image('sky', 'https://labs.phaser.io/assets/skies/space3.png');
    this.load.image('ground', 'https://labs.phaser.io/assets/sprites/platform.png');
    this.load.image('star', 'https://labs.phaser.io/assets/sprites/star.png');
    this.load.image('bomb', 'https://labs.phaser.io/assets/sprites/bomb.png');
    this.load.image('powerup', 'https://labs.phaser.io/assets/sprites/powerup.png');
    this.load.audio('bgmusic', 'https://labs.phaser.io/assets/audio/loop.ogg');

    // Spritesheets
    this.load.spritesheet('dude', 'https://labs.phaser.io/assets/sprites/dude.png', { frameWidth: 32, frameHeight: 48 });
    this.load.spritesheet('enemy', 'https://labs.phaser.io/assets/sprites/baddie.png', { frameWidth: 32, frameHeight: 32 });
    this.load.spritesheet('boss', 'https://labs.phaser.io/assets/sprites/mushroom-32x32.png', { frameWidth: 32, frameHeight: 32 });
  }

  function create() {
    selectedSkin = document.getElementById('skinSelect').value;

    this.add.image(config.width / 2, config.height / 2, 'sky').setScrollFactor(0);
    music = this.sound.add('bgmusic', { loop: true });
    music.play();

    platforms = this.physics.add.staticGroup();
    createLevel(this);

    player = this.physics.add.sprite(100, 450, selectedSkin);
    player.setBounce(0.2);
    player.setCollideWorldBounds(true);

    createAnimations.call(this, selectedSkin);

    this.physics.add.collider(player, platforms);
    cursors = this.input.keyboard.createCursorKeys();

    if (isMobile) {
      this.input.on('pointerdown', () => pointerJump = true);
      this.input.on('pointerup', () => pointerJump = false);
    }

    stars = this.physics.add.group();
    this.physics.add.collider(stars, platforms);
    this.physics.add.overlap(player, stars, collectStar, null, this);

    scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '24px', fill: '#fff' }).setScrollFactor(0);
    healthText = this.add.text(16, 48, 'Health: 3', { fontSize: '24px', fill: '#fff' }).setScrollFactor(0);

    bombs = this.physics.add.group();
    this.physics.add.collider(bombs, platforms);
    this.physics.add.collider(player, bombs, takeDamage, null, this);

    powerUps = this.physics.add.group();
    this.physics.add.collider(powerUps, platforms);
    this.physics.add.overlap(player, powerUps, collectPowerUp, null, this);

    enemies = this.physics.add.group();
    this.physics.add.collider(enemies, platforms);
    this.physics.add.collider(player, enemies, takeDamage, null, this);

    boss = this.physics.add.sprite(700, 100, 'boss').setScale(2);
    boss.setBounce(1);
    boss.setCollideWorldBounds(true);
    boss.setVelocity(Phaser.Math.Between(-150, 150), 20);
    boss.setVisible(false);
    this.physics.add.collider(boss, platforms);
    this.physics.add.collider(player, boss, takeDamage, null, this);

    loadEntities(this);

    window.addEventListener('beforeunload', () => {
      localStorage.setItem('saveScore', score);
      localStorage.setItem('saveLevel', level);
      localStorage.setItem('saveHealth', health);
    });

    if (localStorage.getItem('saveScore')) {
      score = parseInt(localStorage.getItem('saveScore'));
      level = parseInt(localStorage.getItem('saveLevel'));
      health = parseInt(localStorage.getItem('saveHealth'));
      scoreText.setText('Score: ' + score);
      healthText.setText('Health: ' + health);
    }
  }

  function update() {
    if (cursors.left.isDown) {
      player.setVelocityX(-160);
      player.anims.play('left', true);
    } else if (cursors.right.isDown) {
      player.setVelocityX(160);
      player.anims.play('right', true);
    } else {
      player.setVelocityX(0);
      player.anims.play('turn');
    }

    if ((cursors.up.isDown || pointerJump) && player.body.touching.down) {
      player.setVelocityY(-330);
    }
  }

  function createAnimations(skin) {
    const anims = this.anims;
    if (skin === 'dude') {
      anims.create({ key: 'left', frames: anims.generateFrameNumbers('dude', { start: 0, end: 3 }), frameRate: 10, repeat: -1 });
      anims.create({ key: 'turn', frames: [{ key: 'dude', frame: 4 }], frameRate: 20 });
      anims.create({ key: 'right', frames: anims.generateFrameNumbers('dude', { start: 5, end: 8 }), frameRate: 10, repeat: -1 });
    } else if (skin === 'enemy') {
      anims.create({ key: 'left', frames: anims.generateFrameNumbers('enemy', { start: 0, end: 1 }), frameRate: 5, repeat: -1 });
      anims.create({ key: 'turn', frames: [{ key: 'enemy', frame: 1 }], frameRate: 20 });
      anims.create({ key: 'right', frames: anims.generateFrameNumbers('enemy', { start: 2, end: 3 }), frameRate: 5, repeat: -1 });
    }
  }

  function collectStar(player, star) {
    star.disableBody(true, true);
    score += 10;
    scoreText.setText('Score: ' + score);

    if (stars.countActive(true) === 0) {
      level++;
      createLevel(this);
      loadEntities(this);
      if (level === 3) {
        boss.setVisible(true);
      }
    }
  }

  function collectPowerUp(player, powerup) {
    powerup.disableBody(true, true);
    score += 50;
    player.setTint(0x00ff00);
    this.time.delayedCall(2000, () => player.clearTint(), [], this);
    scoreText.setText('Score: ' + score);
  }

  function takeDamage(player, enemy) {
    health--;
    healthText.setText('Health: ' + health);
    player.setTint(0xff0000);
    this.time.delayedCall(1000, () => player.clearTint(), [], this);
    if (health <= 0) {
      this.physics.pause();
      player.anims.play('turn');
      music.stop();
      scoreText.setText('Game Over! Final Score: ' + score);
    }
  }

  function createLevel(scene) {
    platforms.clear(true, true);
    platforms.create(config.width / 2, config.height - 32, 'ground').setScale(2).refreshBody();
    platforms.create(600, 400 - (level * 20), 'ground');
    platforms.create(50, 250 - (level * 10), 'ground');
    platforms.create(750, 220 - (level * 10), 'ground');
  }

  function loadEntities(scene) {
    stars.clear(true, true);
    bombs.clear(true, true);
    powerUps.clear(true, true);
    enemies.clear(true, true);

    for (let i = 0; i < 12; i++) {
      stars.create(Phaser.Math.Between(0, config.width), 0, 'star').setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
    }

    powerUps.create(Phaser.Math.Between(100, config.width - 100), 0, 'powerup').setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

    const enemy = enemies.create(Phaser.Math.Between(100, config.width - 100), 0, 'enemy');
    enemy.setBounce(1);
    enemy.setCollideWorldBounds(true);
    enemy.setVelocity(Phaser.Math.Between(-100, 100), 20);
  }
</script>
</body>
</html>
